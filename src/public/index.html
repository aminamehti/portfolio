<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Interactive Story Generator</title>
<style>
    body { font-family: Arial, sans-serif; }
    #storyOutput { margin-top: 20px; padding-bottom: 20px; border-bottom: 1px solid #ccc; }
    button { margin-right: 10px; }
</style>
</head>
<body>
<h1>Interactive Story Generator</h1>
<label for="storyInput">Enter your story idea:</label>
<input type="text" id="storyInput" placeholder="Start typing..." size="50">
<button onclick="startStory()">Generate Story</button>
<div id="storyOutput"></div>

<script>
async function startStory() {
    const input = encodeURIComponent(document.getElementById('storyInput').value);
    const response = await fetch(`/api/story?prompt=${input}&direction=Provide an exposition of the story.`);
    const data = await response.json();
    if (data.error) {
        displayError(data.error);
    } else {
        displayPart(data, 'exposition');
    }
}

function displayPart(data, section) {
    const output = document.getElementById('storyOutput');
    let storyHtml = `<p>${data.story}</p>`;
    if (data.choices.length > 0) {
        const choicesHtml = data.choices.map((choice, index) =>
            `<button onclick="choosePath('${choice}', '${section}')">Option ${String.fromCharCode(65 + index)}: ${choice}</button>`
        ).join(' ');
        storyHtml += choicesHtml;
    } else {
        storyHtml += "<p>No options available to continue the story. Check if the story part is supposed to end here or not.</p>"; // Fallback message
    }
    output.innerHTML = output.innerHTML + "<br>" + storyHtml; // Ensure separation between story parts
}

function displayError(message) {
    const output = document.getElementById('storyOutput');
    output.innerHTML = `<p style="color: red;">Error: ${message}</p>`;
}

async function choosePath(choice, section) {
    const nextSection = determineNextSection(section);
    const prompt = encodeURIComponent(choice);  // Use choice to influence the next part of the story
    const response = await fetch(`/api/story?prompt=${prompt}&direction=${nextSection}`);
    const data = await response.json();
    if (data.error) {
        displayError(data.error);
    } else {
        displayPart(data, nextSection);
    }
}

function determineNextSection(currentSection) {
    switch (currentSection) {
        case 'exposition': return 'Continue with the rising action.';
        case 'rising action': return 'Continue with the main plot events.';
        case 'main plot events': return 'Continue with the falling action.';
        case 'falling action': return 'Provide the conclusion.';
        default: return 'Provide an exposition of the story.'; // Cycles back to start if needed
    }
}
</script>
</body>
</html>
